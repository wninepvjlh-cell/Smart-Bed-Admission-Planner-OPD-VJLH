<!doctype html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard - Smart Bed Admission Planner</title>
  <link rel="stylesheet" href="styles.css">
  <!-- <script src="https://cdn.tailwindcss.com"></script> -->
  <!-- <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script> -->
  <!-- <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
  <script src="firebase-init.js"></script>
  <script src="firestore-sync.js"></script>
  <script src="access-control.js"></script> -->
</head>
<body>
  <button type="button" id="logoutBtn" class="logout-button">Logout</button>
  <header style="background: linear-gradient(135deg, #80deea 0%, #81c784 100%); box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);">
    <div style="padding: 24px; text-align: center;">
      <h1 style="font-size: 2.2rem; font-weight: 600; color: white; margin: 0;">Smart Bed Admission Planner</h1>
      <div style="font-size: 1.2rem; font-weight: 400; color: white;">‡πÇ‡∏£‡∏á‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•‡πÄ‡∏ß‡∏ä‡∏ä‡∏≤‡∏£‡∏±‡∏Å‡∏©‡πå ‡∏•‡∏≥‡∏õ‡∏≤‡∏á</div>
      <div style="font-size: 1rem; margin-top: 8px; color: rgba(255,255,255,0.9);">‡πÄ‡∏ß‡∏ä‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå‡∏ü‡∏∑‡πâ‡∏ô‡∏ü‡∏π - ‡∏á‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡∏ô‡∏≠‡∏Å</div>
    </div>
  </header>
  <nav style="background: white; padding: 16px 24px; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08); width: 100%; margin-bottom: 0;">
    <div style="display:flex; align-items:center; gap:12px; flex-wrap:wrap;">
      <div style="display:flex; gap:12px; flex-wrap:wrap; justify-content:center; flex:1 1 auto;">
        <a class="nav-button" href="dashboard.html" style="padding: 10px 20px; border-radius: 8px; background: linear-gradient(135deg,#4dd0e1 0%,#26c6da 100%); font-size: 15px; font-weight: 600; color: white; text-decoration: none; box-shadow: 0 4px 12px rgba(77,208,225,0.25);">Dashboard</a>
        <a class="nav-button" href="predict.html" style="padding: 10px 20px; border-radius: 8px; background: white; font-size: 15px; font-weight: 500; color: #00796b;">‡∏Ñ‡∏≤‡∏î‡∏Å‡∏≤‡∏£‡∏ì‡πå‡∏ß‡∏±‡∏ô Admit ‡πÄ‡∏£‡πá‡∏ß‡∏™‡∏∏‡∏î</a>
        <a class="nav-button" href="booking.html" style="padding: 10px 20px; border-radius: 8px; background: white; font-size: 15px; font-weight: 500; color: #00796b; text-decoration: none;">‡∏à‡∏≠‡∏á‡πÄ‡∏ï‡∏µ‡∏¢‡∏á Admit</a>
        <a class="nav-button" href="registry.html" style="padding: 10px 20px; border-radius: 8px; background: white; font-size: 15px; font-weight: 500; color: #00796b;">‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏à‡∏≠‡∏á‡πÄ‡∏ï‡∏µ‡∏¢‡∏á</a>
        <a class="nav-button" href="ipd.html" style="padding: 10px 20px; border-radius: 8px; background: white; font-size: 15px; font-weight: 500; color: #00796b;">‡∏´‡∏≠‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡πÉ‡∏ô(IPD)</a>
        <a class="nav-button" href="data-archive.html" style="padding: 10px 20px; border-radius: 8px; background: white; font-size: 15px; font-weight: 500; color: #00796b;">‡∏Ñ‡∏•‡∏±‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</a>
      </div>
    </div>
  </nav>
  <div class="app-container">
    <main style="padding:24px;background:linear-gradient(135deg,#e0f7fa 0%,#e8f5e9 50%,#f1f8e9 100%);">
      <div style="max-width:1100px;margin:0 auto;display:flex;flex-direction:column;gap:24px;">
        <section style="background:linear-gradient(135deg,#b2ebf2 0%,#81c784 100%);border-radius:24px;padding:24px 28px;display:flex;flex-wrap:wrap;align-items:center;justify-content:space-between;gap:16px;box-shadow:0 6px 20px rgba(129,199,132,0.18);">
          <div>
            <h2 style="margin:0;font-size:28px;color:#004d40;font-weight:700;display:flex;align-items:center;gap:14px;">
              <span style="display:inline-flex;align-items:center;justify-content:center;width:36px;height:36px;border-radius:50%;background:rgba(0,150,136,0.08);">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#00796b" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round">
                  <rect x="3" y="3" width="18" height="18" rx="4"/>
                  <path d="M7 15.5 10.5 12l2.5 2 4-4.5"/>
                  <path d="M7 7h0.01"/>
                  <path d="M12 7h0.01"/>
                  <path d="M17 7h0.01"/>
                </svg>
              </span>
              Dashboard
            </h2>
            <p style="margin:8px 0 0 0;color:#004d40;font-weight:500;">‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏ï‡∏µ‡∏¢‡∏á IPD ‡∏ä‡∏±‡πâ‡∏ô 2 ‡πÅ‡∏•‡∏∞‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡πÄ‡∏ï‡∏µ‡∏¢‡∏á</p>
          </div>
          <div style="padding:16px 20px;min-width:220px;text-align:center;">
            <div style="font-size:0.85rem;font-weight:600;color:#00796b;">‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</div>
            <div id="dashboardDateTime" style="margin-top:6px;font-size:0.95rem;font-weight:700;color:#004d40;">-</div>
          </div>
        </section>

        <section style="display:flex;flex-wrap:wrap;gap:16px;">
          <div style="flex:1 1 260px;background:#fff;border-radius:20px;box-shadow:0 4px 16px rgba(0,0,0,0.08);padding:20px;">
            <div style="display:flex;align-items:center;gap:10px;margin-bottom:12px;color:#009688;font-weight:600;font-size:1.4rem;">
              <span style="display:inline-flex;align-items:center;justify-content:center;width:30px;height:30px;border-radius:50%;background:rgba(0,150,136,0.08);">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#009688" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round">
                  <rect x="3" y="11" width="18" height="6" rx="2"/>
                  <path d="M6 11V9a3 3 0 0 1 3-3h6a3 3 0 0 1 3 3v2"/>
                  <path d="M5 17v2.5"/>
                  <path d="M19 17v2.5"/>
                </svg>
              </span>
              <span>Active Beds</span>
            </div>
            <div style="display:flex;align-items:center;gap:8px;font-size:1.6rem;font-weight:700;color:#00695c;">
              <span id="dashboard-active-bed-floor2">-</span>
              <span style="font-size:1rem;font-weight:500;color:#00796b;">/ 18 ‡πÄ‡∏ï‡∏µ‡∏¢‡∏á</span>
            </div>
          </div>
        </section>

        <section style="background:#fff;border-radius:20px;box-shadow:0 4px 16px rgba(0,0,0,0.06);padding:24px;">
          <div style="display:flex;flex-wrap:wrap;align-items:center;justify-content:space-between;gap:12px;margin-bottom:20px;">
            <h3 style="margin:0;font-size:1.4rem;color:#006064;font-weight:700;display:flex;align-items:center;gap:10px;">
              <span style="display:inline-flex;align-items:center;justify-content:center;width:28px;height:28px;border-radius:50%;background:rgba(0,150,136,0.1);">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#009688" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round">
                  <rect x="4" y="9" width="16" height="9" rx="2" ry="2"/>
                  <path d="M8 9V7a4 4 0 0 1 8 0v2"/>
                  <path d="M6 18v2"/>
                  <path d="M18 18v2"/>
                  <line x1="10" y1="13" x2="14" y2="13"/>
                  <line x1="12" y1="11" x2="12" y2="15"/>
                </svg>
              </span>
              ‡∏´‡∏≠‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡πÉ‡∏ô‡∏ä‡∏±‡πâ‡∏ô2
            </h3>
            <p style="margin:0;font-size:0.85rem;color:#00796b;">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡∏ó‡∏∏‡∏Å 5 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ</p>
          </div>
          <div style="display:flex;flex-wrap:wrap;gap:16px;">
            <div style="background:#fff;border-radius:14px;box-shadow:0 2px 8px rgba(0,180,180,0.08);padding:16px 14px 12px 14px;flex:1 1 320px;max-width:520px;border-bottom:4px solid;border-image:linear-gradient(90deg,#b2ebf2 0%,#4dd0e1 50%,#80cbc4 100%) 1;display:flex;flex-direction:column;align-items:flex-start;">
              <div style="display:flex;align-items:center;gap:7px;margin-bottom:8px;">
                <svg width="18" height="18" viewBox="0 0 32 32" fill="none" stroke="url(#bedLinear1)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="display:block;">
                  <defs>
                    <linearGradient id="bedLinear1" x1="0" y1="0" x2="32" y2="0" gradientUnits="userSpaceOnUse">
                      <stop stop-color="#b2ebf2"/>
                      <stop offset="0.5" stop-color="#4dd0e1"/>
                      <stop offset="1" stop-color="#80cbc4"/>
                    </linearGradient>
                  </defs>
                  <rect x="4" y="16" width="24" height="8" rx="3"/>
                  <rect x="7" y="10" width="18" height="7" rx="2.5"/>
                  <line x1="4" y1="24" x2="28" y2="24"/>
                </svg>
                <span style="font-size:0.95rem;font-weight:600;color:#0097a7;letter-spacing:0.5px;">‡πÄ‡∏ï‡∏µ‡∏¢‡∏á‡∏™‡∏≤‡∏°‡∏±‡∏ç</span>
              </div>
              <div style="display:flex;gap:10px;align-items:center;">
                <div style="display:flex;flex-direction:column;align-items:center;gap:2px;font-size:1.1rem;font-weight:600;color:#0097a7;background:#e0f7fa;border-radius:6px;padding:2px 7px 2px 5px;min-width:40px;">
                  <div style="display:flex;flex-direction:column;flex-grow:1;justify-content:flex-end;align-items:center;height:40px;">
                    <div style="display:flex;align-items:center;gap:4px;">
                      <svg width="18" height="18" viewBox="0 0 24 24" fill="#4dd0e1" style="vertical-align:middle;"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg>
                      <span id="dashboard-male-standard-floor2" style="color:#0097a7;">-</span>
                    </div>
                    <span style="font-size:0.8rem;color:#0097a7;margin-top:auto;margin-bottom:0;align-self:flex-end;">(‡∏ä‡∏≤‡∏¢)</span>
                  </div>
                </div>
                <div style="display:flex;flex-direction:column;align-items:center;gap:2px;font-size:1.1rem;font-weight:600;color:#43a047;background:#e8f5e9;border-radius:6px;padding:2px 7px 2px 5px;min-width:40px;">
                  <div style="display:flex;flex-direction:column;flex-grow:1;justify-content:flex-end;align-items:center;height:40px;">
                    <div style="display:flex;align-items:center;gap:4px;">
                      <svg width="18" height="18" viewBox="0 0 24 24" fill="#43a047" style="vertical-align:middle;"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm6 8c0-2.21-3.58-4-8-4s-8 1.79-8 4v2h16v-2z"/></svg>
                      <span id="dashboard-female-standard-floor2" style="color:#43a047;">-</span>
                    </div>
                    <span style="font-size:0.8rem;color:#43a047;margin-top:auto;margin-bottom:0;align-self:flex-end;">(‡∏´‡∏ç‡∏¥‡∏á)</span>
                  </div>
                </div>
              </div>
            </div>

            <div style="background:#fff;border-radius:14px;box-shadow:0 2px 8px rgba(0,180,180,0.08);padding:16px 14px 12px 14px;flex:1 1 320px;max-width:520px;border-bottom:4px solid;border-image:linear-gradient(90deg,#b2ebf2 0%,#26c6da 50%,#43a047 100%) 1;display:flex;flex-direction:column;align-items:flex-start;">
              <div style="display:flex;align-items:center;gap:7px;margin-bottom:8px;">
                <svg width="18" height="18" viewBox="0 0 32 32" fill="none" stroke="url(#bedLinear2)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="display:block;">
                  <defs>
                    <linearGradient id="bedLinear2" x1="0" y1="0" x2="32" y2="0" gradientUnits="userSpaceOnUse">
                      <stop stop-color="#b2ebf2"/>
                      <stop offset="0.5" stop-color="#26c6da"/>
                      <stop offset="1" stop-color="#43a047"/>
                    </linearGradient>
                  </defs>
                  <rect x="4" y="16" width="24" height="8" rx="3"/>
                  <rect x="7" y="10" width="18" height="7" rx="2.5"/>
                  <line x1="4" y1="24" x2="28" y2="24"/>
                </svg>
                <span style="font-size:0.95rem;font-weight:600;color:#26c6da;letter-spacing:0.5px;">‡∏´‡πâ‡∏≠‡∏á‡∏û‡∏¥‡πÄ‡∏®‡∏©</span>
              </div>
              <div style="display:flex;gap:10px;align-items:center;">
                <div style="display:flex;flex-direction:column;align-items:center;gap:2px;font-size:1.1rem;font-weight:600;color:#0097a7;background:#e0f7fa;border-radius:6px;padding:2px 7px 2px 5px;min-width:40px;">
                  <div style="display:flex;flex-direction:column;flex-grow:1;justify-content:flex-end;align-items:center;height:40px;">
                    <div style="display:flex;align-items:center;gap:4px;">
                      <svg width="18" height="18" viewBox="0 0 24 24" fill="#4dd0e1" style="vertical-align:middle;"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg>
                      <span id="dashboard-male-special-floor2" style="color:#0097a7;">-</span>
                    </div>
                    <span style="font-size:0.8rem;color:#0097a7;margin-top:auto;margin-bottom:0;align-self:flex-end;margin-right:6px;">(‡∏ä‡∏≤‡∏¢)</span>
                  </div>
                </div>
                <div style="display:flex;flex-direction:column;align-items:center;gap:2px;font-size:1.1rem;font-weight:600;color:#43a047;background:#e8f5e9;border-radius:6px;padding:2px 7px 2px 5px;min-width:40px;">
                  <div style="display:flex;flex-direction:column;flex-grow:1;justify-content:flex-end;align-items:center;height:40px;">
                    <div style="display:flex;align-items:center;gap:4px;">
                      <svg width="18" height="18" viewBox="0 0 24 24" fill="#43a047" style="vertical-align:middle;"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm6 8c0-2.21-3.58-4-8-4s-8 1.79-8 4v2h16v-2z"/></svg>
                      <span id="dashboard-female-special-floor2" style="color:#43a047;">-</span>
                    </div>
                    <span style="font-size:0.8rem;color:#43a047;margin-top:auto;margin-bottom:0;align-self:flex-end;margin-right:6px;">(‡∏´‡∏ç‡∏¥‡∏á)</span>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </section>


        <div style="width:100%;max-width:1100px;min-width:320px;margin:0 auto;box-sizing:border-box;display:flex;flex-direction:row;gap:24px;justify-content:center;align-items:stretch;">
          <section style="background:#fff;border-radius:16px;box-shadow:0 2px 8px rgba(0,0,0,0.06);padding:20px 24px 32px 24px;width:50%;min-width:220px;max-width:550px;min-height:420px;box-sizing:border-box;display:flex;flex-direction:column;justify-content:stretch;align-items:stretch;">
            <h2 class="dashboard-graph-title" style="margin-top:0;color:#006064;font-family:'Sarabun','Prompt','Segoe UI',Arial,sans-serif;font-weight:700;letter-spacing:0.2px;">Proportion of Disease Groups Admitted</h2>
            <canvas id="mainDiseasePieChart" height="180"></canvas>
            <div id="mainDiseasePieLegend" style="margin-top:18px;"></div>
          </section>
          <section style="background:#fff;border-radius:16px;box-shadow:0 2px 8px rgba(0,0,0,0.06);padding:20px 24px 32px 24px;width:50%;min-width:220px;max-width:550px;min-height:420px;box-sizing:border-box;display:flex;flex-direction:column;justify-content:stretch;align-items:stretch;">
            <h2 class="dashboard-graph-title" style="margin-top:0;color:#006064;font-family:'Sarabun','Prompt','Segoe UI',Arial,sans-serif;font-weight:700;letter-spacing:0.2px;">IMC : Non-IMC Ratio (Admitted)</h2>
            <canvas id="imcNonImcBarChart" height="220"></canvas>
            <div id="imcNonImcBarLegend" style="margin-top:18px;"></div>
            <div style="display:flex;justify-content:center;gap:32px;margin-top:18px;font-size:1.08rem;font-weight:500;">
              <div style="display:flex;align-items:center;gap:8px;">
                <span style="display:inline-block;width:18px;height:18px;background:#4dd0e1;border-radius:4px;margin-right:4px;"></span>
                <span>IMC</span>
                <span style="color:#00796b;font-weight:700;margin-left:4px;">=
                  <span id="imcTotal"></span>
                </span>
              </div>
              <div style="display:flex;align-items:center;gap:8px;">
                <span style="display:inline-block;width:18px;height:18px;background:#b2ebf2;border-radius:4px;margin-right:4px;"></span>
                <span>Non-IMC</span>
                <span style="color:#0097a7;font-weight:700;margin-left:4px;">=
                  <span id="nonimcTotal"></span>
                </span>
              </div>
            </div>
          </section>
        </div>

        <!-- Booking Confirmed (Dashboard) moved below graphs -->
        <section style="background:#fff;border-radius:16px;box-shadow:0 2px 8px rgba(0,0,0,0.06);padding:24px 24px 32px 24px;width:100%;max-width:1100px;min-width:320px;margin:32px auto 0 auto;display:flex;flex-direction:column;">
          <div style="display:flex;align-items:center;gap:10px;margin-bottom:16px;">
            <h3 style="margin:0;font-size:1.2rem;color:#006064;font-weight:700;">
              <span style="display:inline-flex;align-items:center;justify-content:center;width:28px;height:28px;border-radius:50%;background:rgba(46,125,50,0.1);">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#388e3c" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round">
                  <rect x="4" y="9" width="16" height="9" rx="2" ry="2"/>
                  <path d="M8 9V7a4 4 0 0 1 8 0v2"/>
                </svg>
              </span>
              Booking Confirmed
            </h3>
          </div>
          <div id="dashboard-confirmed-list">
            <!-- Confirmed patient cards will be rendered here -->
          </div>
        </section>

        <!-- Waiting List Section -->
        <section style="background:#fff;border-radius:16px;box-shadow:0 2px 8px rgba(0,0,0,0.06);padding:20px 24px 28px 24px;width:100%;max-width:1100px;min-width:320px;margin:0 auto 24px auto;display:flex;flex-direction:column;align-items:flex-start;">
          <div style="display:flex;align-items:center;gap:10px;margin-bottom:10px;">
            <h3 style="margin:0;font-size:1.15rem;color:#006064;font-weight:700;display:flex;align-items:center;gap:8px;">
              <span style="display:inline-flex;align-items:center;justify-content:center;width:26px;height:26px;border-radius:50%;background:rgba(0,150,136,0.10);">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#009688" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round">
                  <circle cx="12" cy="8" r="4"/>
                  <rect x="4" y="16" width="16" height="4" rx="2"/>
                </svg>
              </span>
              Waiting list
            </h3>
          </div>
          <div style="font-size:1.05rem;font-weight:600;color:#00796b;">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡∏£‡∏≠ Admit (Booking + Booking Confirmed): <span id="dashboard-waiting-list-count">-</span> ‡∏£‡∏≤‡∏¢</div>
        </section>

        <section style="width:100%;max-width:1100px;min-width:320px;margin:0 auto;box-sizing:border-box;background:linear-gradient(135deg,#d7f5f7 0%,#e2f8ef 50%,#f0fbf7 100%);border-radius:20px;box-shadow:0 8px 24px rgba(0,150,136,0.12);padding:24px 24px 32px 24px;display:flex;flex-direction:column;border-left:6px solid #4dd0e1;">
          <div style="display:flex;align-items:center;gap:10px;margin-bottom:12px;background:linear-gradient(135deg,#b2ebf2 0%,#a5d6a7 100%);border-radius:10px;padding:6px 12px 6px 10px;box-shadow:0 6px 18px rgba(77,208,225,0.18);">
            <svg width="18" height="18" viewBox="0 0 32 32" fill="none" stroke="#00796b" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="display:block;">
              <rect x="6" y="10" width="20" height="12" rx="4"/>
              <rect x="12" y="14" width="8" height="4" rx="2"/>
              <circle cx="16" cy="20" r="2"/>
            </svg>
            <span style="font-size:1rem;font-weight:600;color:#006064;letter-spacing:0.5px;">Booking</span>
          </div>
          <div style="font-size:0.95rem;font-weight:500;color:#006064;margin-bottom:16px;">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡∏à‡∏≠‡∏á‡πÄ‡∏ï‡∏µ‡∏¢‡∏á ‡πÅ‡∏¢‡∏Å‡∏ï‡∏≤‡∏°‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÇ‡∏£‡∏Ñ</div>
          <div style="width:100%;margin-bottom:12px;background:linear-gradient(135deg,rgba(178,235,242,0.95) 0%,rgba(165,214,167,0.9) 100%);padding:16px;border-radius:16px;box-shadow:0 6px 20px rgba(0,151,167,0.18);">
            <table style="width:100%;border-collapse:separate;border-spacing:0;font-size:1rem;background:rgba(255,255,255,0.95);border-radius:12px;overflow:hidden;box-shadow:0 2px 8px rgba(0,0,0,0.06);">
              <thead>
                <tr style="background:linear-gradient(90deg,#b2ebf2 0%,#a5d6a7 100%);color:#006064;">
                  <th style="text-align:left;padding:10px 12px;font-weight:600;">‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÇ‡∏£‡∏Ñ</th>
                  <th style="text-align:right;padding:10px 12px;font-weight:600;">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô Booking</th>
                </tr>
              </thead>
              <tbody id="bookingByDiseaseBody" style="color:#006064;">
                <!-- Filled by JS -->
              </tbody>
              <tfoot>
                <tr style="font-weight:bold;background:linear-gradient(90deg,rgba(178,235,242,0.85) 0%,rgba(165,214,167,0.85) 100%);color:#004d40;">
                  <td style="padding:10px 12px;">Total</td>
                  <td style="text-align:right;padding:10px 12px;" id="bookingTotal"></td>
                </tr>
              </tfoot>
            </table>
          </div>
          <div style="align-self:center;width:120px;height:5px;border-radius:999px;background:linear-gradient(90deg,#4dd0e1 0%,#26c6da 50%,#66bb6a 100%);"></div>
        </section>

        <div style="width:100%;max-width:1100px;min-width:320px;margin:0 auto;box-sizing:border-box;display:flex;flex-wrap:wrap;gap:24px;justify-content:center;align-items:stretch;">
          <section style="flex:1 1 360px;min-width:260px;background:#fff;border-radius:16px;box-shadow:0 2px 8px rgba(0,0,0,0.06);padding:24px 24px 32px 24px;display:flex;flex-direction:column;">
            <h2 class="dashboard-graph-title" style="margin-top:0;">Waiting time (IMC : Non-IMC)</h2>
            <canvas id="waitingTimeLineChart" height="220"></canvas>
            <div id="waitingTimeLineLegend" style="margin-top:18px;"></div>
          </section>
          <section style="flex:1 1 260px;min-width:220px;background:#fff;border-radius:16px;box-shadow:0 2px 8px rgba(0,0,0,0.06);padding:24px 24px 32px 24px;display:flex;flex-direction:column;">
            <h2 class="dashboard-graph-title" style="margin-top:0;">‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á‡∏≠‡∏≠‡∏Å‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢</h2>
            <canvas id="appointmentChannelBarChart" height="220"></canvas>
            <div style="margin-top:16px;font-size:0.95rem;color:#006064;font-weight:500;">‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î <span id="appointmentChannelTotal">0</span> ‡∏£‡∏≤‡∏¢</div>
          </section>
        </div>
      </div>
    </main>
  </div>

  <footer style="background: linear-gradient(135deg,#80deea 0%,#81c784 100%); padding:20px;text-align:center;width:100%;">
    <p style="color:white;font-size:14px;margin:0;">¬© 2024 ‡∏á‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡∏ô‡∏≠‡∏Å ‡πÇ‡∏£‡∏á‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•‡πÄ‡∏ß‡∏ä‡∏ä‡∏≤‡∏£‡∏±‡∏Å‡∏©‡πå ‡∏•‡∏≥‡∏õ‡∏≤‡∏á | Smart Bed Admission Planner</p>
  </footer>

  <script>
    document.addEventListener('DOMContentLoaded', function() {
      var btn = document.getElementById('bookingDropdownBtn');
      var content = document.getElementById('bookingDropdownContent');
      if (btn && content) {
        btn.addEventListener('click', function(e) {
          e.stopPropagation();
          content.style.display = content.style.display === 'block' ? 'none' : 'block';
        });
        document.addEventListener('click', function(e) {
          if (!content.contains(e.target) && e.target !== btn) {
            content.style.display = 'none';
          }
        });
      }
    });
  </script>

  <script src="vendor/chart.umd.min.js"></script>
  <script src="vendor/chartjs-plugin-datalabels.min.js"></script>
  <script src="ipd-functions.js"></script>
  <script src="dashboard-waitinglist.js"></script>
  <script>
    function renderIMCRatioChart() {
      if (typeof getIMCNonIMCByDiseaseFloor2 !== 'function') {
        console.error('getIMCNonIMCByDiseaseFloor2() is not loaded');
        return;
      }
      const { imc, nonimc } = getIMCNonIMCByDiseaseFloor2();
      const diseaseLabels = [
        'Stroke',
        'SCI (Tetraplegia)',
        'SCI (Paraplegia)',
        'TBI',
        'Hip fracture',
        '‡∏≠‡∏∑‡πà‡∏ô‡πÜ'
      ];
      var imcTotalEl = document.getElementById('imcTotal');
      var nonimcTotalEl = document.getElementById('nonimcTotal');
      const imcTotal = imc.reduce((a, b) => a + b, 0);
      const nonimcTotal = nonimc.reduce((a, b) => a + b, 0);
      if (imcTotalEl) imcTotalEl.textContent = imcTotal;
      if (nonimcTotalEl) nonimcTotalEl.textContent = nonimcTotal;

      const ctx = document.getElementById('imcNonImcBarChart').getContext('2d');
      if (window.imcNonImcBarChartInstance) {
        window.imcNonImcBarChartInstance.data.datasets[0].data = imc;
        window.imcNonImcBarChartInstance.data.datasets[1].data = nonimc;
        window.imcNonImcBarChartInstance.update();
      } else {
        window.imcNonImcBarChartInstance = new Chart(ctx, {
          type: 'bar',
          data: {
            labels: diseaseLabels,
            datasets: [
              {
                label: 'IMC',
                data: imc,
                backgroundColor: '#4dd0e1',
                borderRadius: 6,
                maxBarThickness: 32
              },
              {
                label: 'Non-IMC',
                data: nonimc,
                backgroundColor: 'rgba(200, 230, 201, 0.85)',
                borderRadius: 6,
                maxBarThickness: 32
              }
            ]
          },
          options: {
            responsive: true,
            plugins: {
              legend: { display: true, position: 'top' },
              title: { display: false },
              datalabels: {
                anchor: 'end',
                align: 'end',
                color: '#0097a7',
                font: { weight: 'bold', size: 16 },
                formatter: function(value) {
                  return value > 0 ? value : '';
                }
              }
            },
            scales: {
              x: { stacked: false },
              y: { beginAtZero: true, title: { display: true, text: '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢' } }
            }
          },
          plugins: [ChartDataLabels]
        });
      }
    }
    function startImcChartLoop() {
      renderIMCRatioChart();
      setInterval(renderIMCRatioChart, 5000);
    }
    document.addEventListener('DOMContentLoaded', function() {
      const ready = window.sbpStorageReadyPromise;
      if (ready && typeof ready.then === 'function') {
        ready.then(startImcChartLoop).catch(function(error) {
          console.warn('Unable to wait for Firestore sync before drawing IMC chart', error);
          startImcChartLoop();
        });
      } else {
        startImcChartLoop();
      }
    });
    window.addEventListener('storage', function(e) {
      if (e.key === 'bookingData') renderIMCRatioChart();
    });
    window.addEventListener('sbpRemoteStorageSync', function(event) {
      const detail = event && event.detail;
      if (!detail || !detail.key || detail.key === 'bookingData') {
        renderIMCRatioChart();
      }
    });
  </script>

  <script>
    function updateFemaleStandardFloor2() {
      const el = document.getElementById('dashboard-female-standard-floor2');
      let val = 0;
      if (window.fetchFemaleStandardIPDFloor2) {
        const fetched = fetchFemaleStandardIPDFloor2();
        if (fetched === null) {
          el.textContent = '-';
          el.title = '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å IPD ‡∏ä‡∏±‡πâ‡∏ô2';
          return;
        }
        val = isNaN(fetched) ? 0 : fetched;
      }
      el.textContent = val;
    }
    function updateMaleStandardFloor2() {
      const el = document.getElementById('dashboard-male-standard-floor2');
      let val = 0;
      if (window.fetchMaleStandardIPDFloor2) {
        val = fetchMaleStandardIPDFloor2();
        if (isNaN(val) || val === null) val = 0;
      }
      el.textContent = val;
    }
    function updateMaleSpecialFloor2() {
      const el = document.getElementById('dashboard-male-special-floor2');
      let val = 0;
      if (window.fetchMaleSpecialIPDFloor2) {
        const fetched = fetchMaleSpecialIPDFloor2();
        if (fetched === null) {
          el.textContent = '0';
          el.title = '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å IPD ‡∏ä‡∏±‡πâ‡∏ô2';
          return;
        }
        val = isNaN(fetched) ? 0 : fetched;
      }
      el.textContent = val;
    }
    function updateFemaleSpecialFloor2() {
      const el = document.getElementById('dashboard-female-special-floor2');
      let val = 0;
      if (window.fetchFemaleSpecialIPDFloor2) {
        const fetched = fetchFemaleSpecialIPDFloor2();
        if (fetched === null) {
          el.textContent = '0';
          el.title = '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å IPD ‡∏ä‡∏±‡πâ‡∏ô2';
          return;
        }
        val = isNaN(fetched) ? 0 : fetched;
      }
      el.textContent = val;
    }
    function updateActiveBedFloor2() {
      const el = document.getElementById('dashboard-active-bed-floor2');
      const activeBeds = localStorage.getItem('ipd_active_beds_floor2');
      if (activeBeds === null) {
        el.textContent = '-';
        el.title = '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å IPD ‡∏ä‡∏±‡πâ‡∏ô2';
      } else {
        el.textContent = activeBeds;
        el.title = '';
      }
    }
    function startIpdCounters() {
      updateFemaleStandardFloor2();
      updateMaleStandardFloor2();
      updateMaleSpecialFloor2();
      updateFemaleSpecialFloor2();
      updateActiveBedFloor2();
      setInterval(updateFemaleStandardFloor2, 5000);
      setInterval(updateMaleStandardFloor2, 5000);
      setInterval(updateMaleSpecialFloor2, 5000);
      setInterval(updateFemaleSpecialFloor2, 5000);
      setInterval(updateActiveBedFloor2, 5000);
    }

    const storageReadyForCounters = window.sbpStorageReadyPromise;
    if (storageReadyForCounters && typeof storageReadyForCounters.then === 'function') {
      storageReadyForCounters.then(startIpdCounters).catch(function(error) {
        console.warn('Unable to wait for Firestore sync before updating IPD counters', error);
        startIpdCounters();
      });
    } else {
      startIpdCounters();
    }
    window.addEventListener('storage', function(e) {
      if (e.key === 'ipd_female_standard_floor2') updateFemaleStandardFloor2();
      if (e.key === 'ipd_male_standard_floor2') updateMaleStandardFloor2();
      if (e.key === 'ipd_male_special_floor2') updateMaleSpecialFloor2();
      if (e.key === 'ipd_female_special_floor2') updateFemaleSpecialFloor2();
      if (e.key === 'ipd_active_beds_floor2') updateActiveBedFloor2();
    });
    window.addEventListener('sbpRemoteStorageSync', function(event) {
      const detail = event && event.detail;
      const key = detail && detail.key;
      if (!key || key === 'ipd_female_standard_floor2') updateFemaleStandardFloor2();
      if (!key || key === 'ipd_male_standard_floor2') updateMaleStandardFloor2();
      if (!key || key === 'ipd_male_special_floor2') updateMaleSpecialFloor2();
      if (!key || key === 'ipd_female_special_floor2') updateFemaleSpecialFloor2();
      if (!key || key === 'ipd_active_beds_floor2') updateActiveBedFloor2();
    });
  </script>

  <script src="dashboard-functions.js"></script>
  <script>
    // Render Booking Confirmed cards in Dashboard
    function renderDashboardConfirmedList() {
      const bookingData = (typeof loadBookingData === 'function') ? loadBookingData() : JSON.parse(localStorage.getItem('bookingData')||'{"confirmed":[]}');
      const confirmedList = (bookingData.confirmed || []).filter(b => (b.call_result === 'confirmed' || b.called === true) && !b.postponed);
      const container = document.getElementById('dashboard-confirmed-list');
      if (!container) return;
      container.innerHTML = '';
      if (confirmedList.length === 0) {
        container.innerHTML = '<div style="padding:40px;text-align:center;color:#999;background:white;border-radius:12px;"><div style="font-size:40px;margin-bottom:12px;opacity:0.5;">‚úÖ</div><div style="font-size:16px;">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô</div></div>';
        return;
      }
      // Split into standard and special
      const specialList = confirmedList.filter(b => (b.bed_type === 'special') || (b.assigned_bed && b.assigned_bed.startsWith('V')));
      const standardList = confirmedList.filter(b => !specialList.includes(b));
      function renderGroup(list, groupType) {
        if (list.length === 0) return '';
        let icon = '', title = '';
        if (groupType === 'standard') {
          icon = `<span style="display:inline-block;width:28px;height:28px;margin-right:8px;vertical-align:middle;"><svg width="28" height="28" viewBox="0 0 32 32" fill="none" stroke="#19724d" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round"><rect x="4" y="16" width="24" height="8" rx="3"/><rect x="7" y="12" width="7" height="4" rx="2"/><rect x="18" y="12" width="7" height="4" rx="2"/><line x1="4" y1="24" x2="4" y2="28"/><line x1="28" y1="24" x2="28" y2="28"/></svg></span>`;
          title = '‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÄ‡∏ï‡∏µ‡∏¢‡∏á‡∏™‡∏≤‡∏°‡∏±‡∏ç';
        } else if (groupType === 'special') {
          icon = `<span style="display:inline-block;width:28px;height:28px;margin-right:8px;vertical-align:middle;"><svg width="28" height="28" viewBox="0 0 32 32" fill="none" stroke="#c2185b" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round"><rect x="6" y="14" width="20" height="10" rx="5"/><ellipse cx="16" cy="14" rx="10" ry="5"/><path d="M11 14c0-2.5 2-4.5 5-4.5s5 2 5 4.5"/></svg></span>`;
          title = '‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏´‡πâ‡∏≠‡∏á‡∏û‡∏¥‡πÄ‡∏®‡∏©';
        }
        let html = `<div style='margin-bottom:32px;'><h4 style='color:#19724d;font-size:18px;font-weight:700;margin-bottom:12px;display:flex;align-items:center;'>${icon}${title}</h4>`;
        html += `<div style='display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));gap:18px;'>`;
        list.sort((a, b) => new Date(a.admit_date) - new Date(b.admit_date));
        list.forEach((booking, index) => {
          // Highlight if admit_date is today
          const isAdmitToday = canAdmitToday(booking.admit_date);
          const cardBg = isAdmitToday ? "background:#d6f5e7;" : "background:#fff;";
          html += `<div style='${cardBg}border-radius:18px;box-shadow:0 4px 14px rgba(0,0,0,0.09);padding:20px 16px 16px 16px;display:flex;flex-direction:column;justify-content:space-between;min-height:200px;position:relative;border:0;'>
            <div style=\"display:flex;justify-content:space-between;align-items:start;margin-bottom:8px;\">
              <div style=\"background:#43a047;color:white;width:36px;height:36px;border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:20px;font-weight:700;box-shadow:0 2px 8px rgba(102,187,106,0.18);\">‚úì</div>
              <div style=\"text-align:right;\"><div style=\"color:#19724d;font-size:13px;font-weight:600;margin-bottom:2px;\">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà Admit</div><div style=\"color:#2e7d32;font-size:15px;font-weight:700;\">${formatDateTH(booking.admit_date)}</div></div>
            </div>
            <div style=\"margin-bottom:6px;display:grid;gap:2px;\">
              <div style=\"color:#999;font-size:11px;font-weight:600;text-transform:uppercase;\">HN</div>
              <div style=\"color:#19724d;font-size:16px;font-weight:700;\">${booking.patient_hn}</div>
              <div style=\"color:#999;font-size:11px;font-weight:600;\">‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏•</div>
              <div style=\"color:#19724d;font-size:14px;font-weight:600;\">${booking.patient_name || '-'}<\/div>
              <div style=\"color:#999;font-size:11px;font-weight:600;margin-top:4px;\">Diagnosis</div>
              <div style=\"color:#c62828;font-size:13px;font-weight:600;\">${booking.diagnosis || '-'}</div>
            </div>
            <div style=\"height:1px;background:linear-gradient(90deg,#e0e0e0 0%,transparent 100%);margin:8px 0 12px 0;\"></div>
            <div style=\"display:flex;gap:8px;justify-content:stretch;margin-top:auto;\">
              <button onclick='event.stopPropagation();openConfirmedDetailModal("${booking.patient_hn}")' style='flex:1;padding:10px 0;background:#f5f5f5;color:#444;border:none;border-radius:8px;cursor:pointer;font-size:13px;font-weight:600;transition:all 0.2s;display:flex;align-items:center;justify-content:center;gap:6px;' onmouseover='this.style.background="#e0e0e0"' onmouseout='this.style.background="#f5f5f5"'><span style="font-size:16px;">üìã</span>‡∏î‡∏π‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
            </div>
          </div>`;
        });
        html += `</div></div>`;
        return html;
      }
      container.innerHTML = renderGroup(standardList, 'standard') + renderGroup(specialList, 'special');
    }
    // Helper: format date TH
    function formatDateTH(dateStr) {
      if (!dateStr) return '-';
      const d = new Date(dateStr);
      if (isNaN(d)) return '-';
      const thMonths = ['‡∏°.‡∏Ñ.','‡∏Å.‡∏û.','‡∏°‡∏µ.‡∏Ñ.','‡πÄ‡∏°.‡∏¢.','‡∏û.‡∏Ñ.','‡∏°‡∏¥.‡∏¢.','‡∏Å.‡∏Ñ.','‡∏™.‡∏Ñ.','‡∏Å.‡∏¢.','‡∏ï.‡∏Ñ.','‡∏û.‡∏¢.','‡∏ò.‡∏Ñ.'];
      return `${d.getDate()} ${thMonths[d.getMonth()]} ${d.getFullYear()+543}`;
    }
    // Helper: can admit today
    function canAdmitToday(admitDate) {
      if (!admitDate) return false;
      const today = new Date();
      const d = new Date(admitDate);
      return d.getFullYear() === today.getFullYear() && d.getMonth() === today.getMonth() && d.getDate() === today.getDate();
    }
    // Dummy handlers for modal actions (should be implemented or imported)
    window.openConfirmedDetailModal = window.openConfirmedDetailModal || function(hn) {
      const bookingData = (typeof loadBookingData === 'function') ? loadBookingData() : JSON.parse(localStorage.getItem('bookingData')||'{}');
      const patient = (bookingData.confirmed || []).find(p => p.patient_hn === hn);
      if (!patient) { alert('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢'); return; }
      // Build modal HTML
      let html = `<div id='dashboard-patient-modal' style='position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.45);z-index:9999;display:flex;align-items:center;justify-content:center;'>`;
      html += `<div style='background:#fff;padding:32px 28px 24px 28px;border-radius:18px;max-width:420px;width:95vw;box-shadow:0 8px 32px rgba(0,0,0,0.18);position:relative;'>`;
      html += `<h3 style='color:#19724d;font-size:22px;font-weight:700;margin:0 0 18px 0;'>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢</h3>`;
      html += `<div style='margin-bottom:10px;'><b>HN:</b> ${patient.patient_hn}</div>`;
      html += `<div style='margin-bottom:10px;'><b>‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏•:</b> ${patient.patient_name || '-'}</div>`;
      html += `<div style='margin-bottom:10px;'><b>Diagnosis:</b> <span style='color:#c62828;'>${patient.diagnosis || '-'}</span></div>`;
      html += `<div style='margin-bottom:10px;'><b>‡∏≠‡∏≤‡∏¢‡∏∏:</b> ${patient.patient_age || '-'} ‡∏õ‡∏µ</div>`;
      html += `<div style='margin-bottom:10px;'><b>‡πÄ‡∏û‡∏®:</b> ${patient.patient_gender || '-'}</div>`;
      html += `<div style='margin-bottom:10px;'><b>‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£:</b> ${patient.patient_phone || '-'}</div>`;
      html += `<div style='margin-bottom:10px;'><b>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà Admit:</b> ${formatDateTH(patient.admit_date)}</div>`;
      html += `<div style='margin-bottom:10px;'><b>‡πÄ‡∏ï‡∏µ‡∏¢‡∏á:</b> ${patient.assigned_bed || '-'}</div>`;
      html += `<div style='margin-bottom:10px;'><b>‡πÅ‡∏û‡πá‡∏Å‡πÄ‡∏Å‡∏à Lab:</b> ${patient.lab_package || '-'}</div>`;
      html += `<div style='margin-bottom:10px;'><b>‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢:</b> ${patient.appointment_channel || '-'}</div>`;
      html += `<div style='margin-bottom:10px;'><b>‡πÇ‡∏£‡∏á‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•‡∏™‡πà‡∏á‡∏ï‡πà‡∏≠:</b> ${patient.refer_hospital || '-'}</div>`;
      html += `<button onclick='document.getElementById("dashboard-patient-modal").remove()' style='margin-top:18px;padding:10px 0;width:100%;background:#43a047;color:white;border:none;border-radius:8px;font-size:16px;font-weight:700;cursor:pointer;'>‡∏õ‡∏¥‡∏î</button>`;
      html += `</div></div>`;
      document.body.insertAdjacentHTML('beforeend', html);
    };
    window.admitPatient = window.admitPatient || function(hn) {
      const bookingData = (typeof loadBookingData === 'function') ? loadBookingData() : JSON.parse(localStorage.getItem('bookingData')||'{}');
      const patient = (bookingData.confirmed || []).find(p => p.patient_hn === hn);
      if (!patient) { alert('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢'); return; }
      // Show modal to select ward
      let html = `<div id='dashboard-admit-modal' style='position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.45);z-index:9999;display:flex;align-items:center;justify-content:center;'>`;
      html += `<div style='background:#fff;padding:32px 28px 24px 28px;border-radius:18px;max-width:420px;width:95vw;box-shadow:0 8px 32px rgba(0,0,0,0.18);position:relative;'>`;
      html += `<h3 style='color:#19724d;font-size:22px;font-weight:700;margin:0 0 18px 0;'>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏≠‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢</h3>`;
      html += `<div style='margin-bottom:16px;'><b>HN:</b> ${patient.patient_hn} <br><b>‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏•:</b> ${patient.patient_name || '-'}</div>`;
      html += `<label for='dashboard-admit-ward' style='font-weight:600;color:#388e3c;'>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏≠‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢ *</label>`;
      html += `<select id='dashboard-admit-ward' style='width:100%;padding:12px;margin:10px 0 18px 0;border:2px solid #c8e6c9;border-radius:8px;font-size:15px;'>`;
      html += `<option value=''>-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏≠‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢ --</option>`;
      html += `<option value='floor2'>‡∏´‡∏≠‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡πÉ‡∏ô‡∏ä‡∏±‡πâ‡∏ô 2</option>`;
      html += `<option value='floor1' disabled>‡∏´‡∏≠‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡πÉ‡∏ô‡∏ä‡∏±‡πâ‡∏ô 1 (Coming Soon)</option>`;
      html += `</select>`;
      html += `<button onclick='confirmDashboardAdmitPatient("${hn}")' style='width:100%;padding:12px;background:linear-gradient(135deg,#66bb6a 0%,#43a047 100%);color:white;border:none;border-radius:8px;font-size:16px;font-weight:700;cursor:pointer;'>‚úì ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏™‡πà‡∏á Admit</button>`;
      html += `<button onclick='document.getElementById("dashboard-admit-modal").remove()' style='width:100%;padding:12px;background:#999;color:white;border:none;border-radius:8px;font-size:16px;font-weight:700;margin-top:10px;cursor:pointer;'>‡∏õ‡∏¥‡∏î</button>`;
      html += `</div></div>`;
      document.body.insertAdjacentHTML('beforeend', html);
    };

    window.confirmDashboardAdmitPatient = function(hn) {
      const ward = document.getElementById('dashboard-admit-ward').value;
      if (!ward) { alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏≠‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢'); return; }
      let bookingData = (typeof loadBookingData === 'function') ? loadBookingData() : JSON.parse(localStorage.getItem('bookingData')||'{}');
      if (!bookingData.admitted) bookingData.admitted = [];
      if (!bookingData.confirmed) bookingData.confirmed = [];
      const idx = bookingData.confirmed.findIndex(p => p.patient_hn === hn);
      if (idx === -1) { alert('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢'); return; }
      const patient = bookingData.confirmed[idx];
      patient.ward = ward;
      patient.floor = ward; // Ensure floor is set for IPD filter
      patient.admit_status = 'waiting'; // Set to 'waiting' for ‡∏£‡∏≠‡∏£‡∏±‡∏ö Admit
      patient.admit_time = new Date().toISOString();
      bookingData.admitted.push(patient);
      bookingData.confirmed.splice(idx, 1);
      localStorage.setItem('bookingData', JSON.stringify(bookingData));
      document.getElementById('dashboard-admit-modal').remove();
      renderDashboardConfirmedList();
      alert('‡∏™‡πà‡∏á Admit ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ñ‡∏π‡∏Å‡∏™‡πà‡∏á‡πÑ‡∏õ‡∏´‡∏≠‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡πÉ‡∏ô‡πÅ‡∏•‡πâ‡∏ß');
    };
    window.openCancelModal = window.openCancelModal || function(hn) { alert('‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å HN: '+hn); };
    // Render on load
    renderDashboardConfirmedList();
    // Re-render on storage change
    window.addEventListener('storage', function(e) {
      if (!e.key || e.key === 'bookingData') renderDashboardConfirmedList();
    });
  </script>

  <script src="dashboard-charts.js"></script>
</body>
</html>