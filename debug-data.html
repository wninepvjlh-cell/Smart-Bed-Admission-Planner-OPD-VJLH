<!DOCTYPE html>
<html>
<head>
    <title>Debug Data</title>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="firebase-init.js"></script>
    <script src="firestore-sync.js"></script>
    <style>
        body { font-family: monospace; padding: 20px; }
        pre { background: #f5f5f5; padding: 15px; border-radius: 5px; }
        .section { margin: 20px 0; border: 2px solid #ddd; padding: 15px; }
    </style>
</head>
<body>
    <script>
        (function runOneTimePatientDataPurge() {
            if (typeof window === 'undefined') {
                return;
            }
            if (window.__sbpFirestoreSyncEnabled) {
                return;
            }
            if (window.__sbpDataPurge) {
                window.__sbpDataPurge();
                return;
            }
            const FLAG_KEY = 'sbp_data_purged_20260103';
            const KEYS_TO_CLEAR = [
                'bookingData',
                'ipdData',
                'ipd_female_standard_floor2',
                'ipd_female_special_floor2',
                'ipd_male_standard_floor2',
                'ipd_male_special_floor2',
                'ipd_active_beds_floor2'
            ];
            window.__sbpDataPurge = function __sbpDataPurge() {
                if (typeof window === 'undefined' || !window.localStorage) {
                    return;
                }
                if (localStorage.getItem(FLAG_KEY)) {
                    return;
                }
                KEYS_TO_CLEAR.forEach(function(key) {
                    try {
                        localStorage.removeItem(key);
                    } catch (error) {
                        console.warn('Unable to remove key from localStorage:', key, error);
                    }
                });
                try {
                    localStorage.setItem(FLAG_KEY, new Date().toISOString());
                } catch (error) {
                    console.warn('Unable to set purge flag in localStorage:', error);
                }
            };
            window.__sbpDataPurge();
        })();
    </script>
    <h1>Debug: ข้อมูลผู้ป่วยในระบบ</h1>
    <div class="section">
        <h2>Booking Data (ทั้งหมด)</h2>
        <pre id="bookingData"></pre>
    </div>
    <div class="section">
        <h2>ผู้ป่วยห้องพิเศษ (VIP) ที่ Admit แล้ว</h2>
        <pre id="vipPatients"></pre>
    </div>
    <div class="section">
        <h2>ผู้ป่วยห้องพิเศษ (VIP) ที่จองแล้ว (Booked)</h2>
        <pre id="vipBooked"></pre>
    </div>
    <div class="section">
        <h2>ผู้ป่วยที่มีวันจำหน่าย 28 ธ.ค. 2568</h2>
        <pre id="discharge28"></pre>
    </div>
    <div class="section">
        <h2>ผู้ป่วยทั้งหมดในระบบ (Admitted + Booked + Confirmed)</h2>
        <pre id="allPatients"></pre>
    </div>
    
    <script>
        function renderDebugData() {
            const bookingData = JSON.parse(localStorage.getItem('bookingData')) || {};
            const bookingEl = document.getElementById('bookingData');
            const vipAdmitEl = document.getElementById('vipPatients');
            const vipBookedEl = document.getElementById('vipBooked');
            const dischargeEl = document.getElementById('discharge28');
            const allPatientsEl = document.getElementById('allPatients');

            if (!bookingEl || !vipAdmitEl || !vipBookedEl || !dischargeEl || !allPatientsEl) {
                return;
            }

            bookingEl.textContent = JSON.stringify(bookingData, null, 2);

            const vipPatients = (bookingData.admitted || []).filter(function(patient) {
                return ['V1', 'V2', 'V3', 'V4', 'V5', 'V6'].includes(patient.assigned_bed);
            });
            vipAdmitEl.textContent = vipPatients.length > 0
                ? JSON.stringify(vipPatients, null, 2)
                : 'ไม่มีผู้ป่วย VIP ที่ Admit แล้ว';

            const vipBooked = [...(bookingData.booked || []), ...(bookingData.confirmed || [])].filter(function(patient) {
                return patient.bed_type === 'special' || patient.bed_type === 'vip' || patient.bed_type === 'พิเศษ';
            });
            vipBookedEl.textContent = vipBooked.length > 0
                ? JSON.stringify(vipBooked, null, 2)
                : 'ไม่มีการจองห้องพิเศษ';

            const discharge28 = (bookingData.admitted || []).filter(function(patient) {
                return patient.expected_discharge_date === '2025-12-28';
            });
            dischargeEl.textContent = discharge28.length > 0
                ? JSON.stringify(discharge28, null, 2)
                : 'ไม่มีผู้ป่วยที่จำหน่ายวันที่ 28';

            const allPatients = [
                ...(bookingData.admitted || []),
                ...(bookingData.booked || []),
                ...(bookingData.confirmed || [])
            ];
            allPatientsEl.textContent = `จำนวนทั้งหมด: ${allPatients.length} คน\n\n` + JSON.stringify(allPatients, null, 2);
        }

        function startDebugPage() {
            renderDebugData();
        }

        function ensureDebugPageReady() {
            const ready = window.sbpStorageReadyPromise;
            if (ready && typeof ready.then === 'function') {
                ready.then(startDebugPage).catch(function(error) {
                    console.warn('Unable to wait for Firestore sync before rendering debug data', error);
                    startDebugPage();
                });
            } else {
                startDebugPage();
            }
        }

        function handleDebugStorageChange(key) {
            if (!key || key === 'bookingData') {
                renderDebugData();
            }
        }

        ensureDebugPageReady();

        window.addEventListener('storage', function(event) {
            const key = event && typeof event.key === 'string' ? event.key : undefined;
            handleDebugStorageChange(key);
        });

        window.addEventListener('sbpRemoteStorageSync', function(event) {
            const detail = event && event.detail;
            const key = detail && typeof detail.key === 'string' ? detail.key : undefined;
            handleDebugStorageChange(key);
        });
    </script>
</body>
</html>
