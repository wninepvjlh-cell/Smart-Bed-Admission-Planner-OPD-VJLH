<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <title>เช็คข้อมูล</title>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="firebase-init.js"></script>
    <script src="firestore-sync.js"></script>
</head>
<body>
    <script>
        (function runOneTimePatientDataPurge() {
            if (typeof window === 'undefined') {
                return;
            }
            if (window.__sbpFirestoreSyncEnabled) {
                return;
            }
            if (window.__sbpDataPurge) {
                window.__sbpDataPurge();
                return;
            }
            const FLAG_KEY = 'sbp_data_purged_20260103';
            const KEYS_TO_CLEAR = [
                'bookingData',
                'ipdData',
                'ipd_female_standard_floor2',
                'ipd_female_special_floor2',
                'ipd_male_standard_floor2',
                'ipd_male_special_floor2',
                'ipd_active_beds_floor2'
            ];
            window.__sbpDataPurge = function __sbpDataPurge() {
                if (typeof window === 'undefined' || !window.localStorage) {
                    return;
                }
                if (localStorage.getItem(FLAG_KEY)) {
                    return;
                }
                KEYS_TO_CLEAR.forEach(function(key) {
                    try {
                        localStorage.removeItem(key);
                    } catch (error) {
                        console.warn('Unable to remove key from localStorage:', key, error);
                    }
                });
                try {
                    localStorage.setItem(FLAG_KEY, new Date().toISOString());
                } catch (error) {
                    console.warn('Unable to set purge flag in localStorage:', error);
                }
            };
            window.__sbpDataPurge();
        })();
    </script>
    <h1>ข้อมูลในระบบ</h1>
    <pre id="output"></pre>

    <script>
        function renderCheckData() {
            const bookingData = JSON.parse(localStorage.getItem('bookingData')) || {
                booked: [],
                confirmed: [],
                admitted: [],
                cancelled: []
            };

            const output = document.getElementById('output');
            if (!output) {
                return;
            }

            output.textContent = JSON.stringify(bookingData, null, 2);

            console.log('Booking Data:', bookingData);
            console.log('Admitted Patients:', bookingData.admitted);
            console.log('Admitted Count:', bookingData.admitted ? bookingData.admitted.length : 0);
        }

        function startCheckDataPage() {
            renderCheckData();
        }

        function ensureCheckDataReady() {
            const ready = window.sbpStorageReadyPromise;
            if (ready && typeof ready.then === 'function') {
                ready.then(startCheckDataPage).catch(function(error) {
                    console.warn('Unable to wait for Firestore sync before showing check data', error);
                    startCheckDataPage();
                });
            } else {
                startCheckDataPage();
            }
        }

        function handleCheckDataStorageChange(key) {
            if (!key || key === 'bookingData') {
                renderCheckData();
            }
        }

        ensureCheckDataReady();

        window.addEventListener('storage', function(event) {
            const key = event && typeof event.key === 'string' ? event.key : undefined;
            handleCheckDataStorageChange(key);
        });

        window.addEventListener('sbpRemoteStorageSync', function(event) {
            const detail = event && event.detail;
            const key = detail && typeof detail.key === 'string' ? detail.key : undefined;
            handleCheckDataStorageChange(key);
        });
    </script>
</body>
</html>